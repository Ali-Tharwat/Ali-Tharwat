name: Generate Streak

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  generate-streak:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate Streak SVG
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat << 'EOF' > generate-streak.js
          const https = require('https');
          const fs = require('fs');

          const username = 'ali-tharwat';
          const token = process.env.GITHUB_TOKEN;

          function fetchContributions() {
            return new Promise((resolve, reject) => {
              const query = `
                query {
                  user(login: "${username}") {
                    contributionsCollection {
                      contributionCalendar {
                        totalContributions
                        weeks {
                          contributionDays {
                            contributionCount
                            date
                          }
                        }
                      }
                    }
                  }
                }
              `;

              const postData = JSON.stringify({ query });
              const options = {
                hostname: 'api.github.com',
                path: '/graphql',
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json',
                  'User-Agent': 'streak-generator'
                }
              };

              const req = https.request(options, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve(JSON.parse(data)));
              });
              req.on('error', reject);
              req.write(postData);
              req.end();
            });
          }

          function calculateStreak(weeks) {
            const allDays = weeks.flatMap(w => w.contributionDays).reverse();
            const today = new Date().toISOString().split('T')[0];
            
            let currentStreak = 0;
            let longestStreak = 0;
            let tempStreak = 0;
            let foundToday = false;

            for (const day of allDays) {
              if (!foundToday && day.date === today) {
                foundToday = true;
              }
              
              if (foundToday || day.date < today) {
                if (day.contributionCount > 0) {
                  if (!foundToday || currentStreak === 0 || day.date === today) {
                    currentStreak++;
                  }
                  tempStreak++;
                  longestStreak = Math.max(longestStreak, tempStreak);
                } else {
                  if (foundToday && currentStreak > 0) {
                    foundToday = false;
                  }
                  tempStreak = 0;
                }
              }
            }

            // Recalculate current streak properly
            currentStreak = 0;
            for (const day of allDays) {
              if (day.contributionCount > 0) {
                currentStreak++;
              } else {
                break;
              }
            }

            return { currentStreak, longestStreak };
          }

          function generateSVG(currentStreak, longestStreak, totalContributions) {
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            
            return `<svg xmlns="http://www.w3.org/2000/svg" width="495" height="195" viewBox="0 0 495 195">
            <defs>
              <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#1a1b27;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#1f2937;stop-opacity:1" />
              </linearGradient>
            </defs>
            <rect width="495" height="195" rx="10" fill="url(#grad)" stroke="#70a5fd" stroke-width="1"/>
            
            <!-- Title -->
            <text x="247.5" y="30" text-anchor="middle" fill="#70a5fd" font-family="Segoe UI, Ubuntu, sans-serif" font-size="18" font-weight="bold">ðŸ”¥ GitHub Streak Stats</text>
            
            <!-- Current Streak -->
            <text x="82.5" y="80" text-anchor="middle" fill="#bf91f3" font-family="Segoe UI, Ubuntu, sans-serif" font-size="14">Current Streak</text>
            <text x="82.5" y="120" text-anchor="middle" fill="#38bdae" font-family="Segoe UI, Ubuntu, sans-serif" font-size="36" font-weight="bold">${currentStreak}</text>
            <text x="82.5" y="145" text-anchor="middle" fill="#70a5fd" font-family="Segoe UI, Ubuntu, sans-serif" font-size="12">days</text>
            
            <!-- Total Contributions -->
            <text x="247.5" y="80" text-anchor="middle" fill="#bf91f3" font-family="Segoe UI, Ubuntu, sans-serif" font-size="14">Total Contributions</text>
            <text x="247.5" y="120" text-anchor="middle" fill="#38bdae" font-family="Segoe UI, Ubuntu, sans-serif" font-size="36" font-weight="bold">${totalContributions}</text>
            <text x="247.5" y="145" text-anchor="middle" fill="#70a5fd" font-family="Segoe UI, Ubuntu, sans-serif" font-size="12">this year</text>
            
            <!-- Longest Streak -->
            <text x="412.5" y="80" text-anchor="middle" fill="#bf91f3" font-family="Segoe UI, Ubuntu, sans-serif" font-size="14">Longest Streak</text>
            <text x="412.5" y="120" text-anchor="middle" fill="#38bdae" font-family="Segoe UI, Ubuntu, sans-serif" font-size="36" font-weight="bold">${longestStreak}</text>
            <text x="412.5" y="145" text-anchor="middle" fill="#70a5fd" font-family="Segoe UI, Ubuntu, sans-serif" font-size="12">days</text>
            
            <!-- Date -->
            <text x="247.5" y="180" text-anchor="middle" fill="#6b7280" font-family="Segoe UI, Ubuntu, sans-serif" font-size="11">Updated: ${dateStr}</text>
          </svg>`;
          }

          async function main() {
            try {
              const data = await fetchContributions();
              const calendar = data.data.user.contributionsCollection.contributionCalendar;
              const { currentStreak, longestStreak } = calculateStreak(calendar.weeks);
              const svg = generateSVG(currentStreak, longestStreak, calendar.totalContributions);
              
              fs.mkdirSync('dist', { recursive: true });
              fs.writeFileSync('dist/streak.svg', svg);
              console.log(`Generated streak: Current=${currentStreak}, Longest=${longestStreak}, Total=${calendar.totalContributions}`);
            } catch (err) {
              console.error('Error:', err);
              process.exit(1);
            }
          }

          main();
          EOF
          node generate-streak.js

      - name: Push to output branch
        uses: crazy-max/ghaction-github-pages@v3
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
