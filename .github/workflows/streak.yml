name: Generate Streak

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  generate-streak:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate Streak SVG
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat << 'EOF' > generate-streak.js
          const https = require('https');
          const fs = require('fs');

          const username = 'ali-tharwat';
          const token = process.env.GITHUB_TOKEN;

          function fetchContributions() {
            return new Promise((resolve, reject) => {
              const query = `
                query {
                  user(login: "${username}") {
                    contributionsCollection {
                      contributionCalendar {
                        totalContributions
                        weeks {
                          contributionDays {
                            contributionCount
                            date
                          }
                        }
                      }
                    }
                  }
                }
              `;

              const postData = JSON.stringify({ query });
              const options = {
                hostname: 'api.github.com',
                path: '/graphql',
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json',
                  'User-Agent': 'streak-generator'
                }
              };

              const req = https.request(options, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve(JSON.parse(data)));
              });
              req.on('error', reject);
              req.write(postData);
              req.end();
            });
          }

          function calculateStreak(weeks) {
            const allDays = weeks.flatMap(w => w.contributionDays).reverse();
            
            let currentStreak = 0;
            let longestStreak = 0;
            let tempStreak = 0;

            // Calculate current streak (from today backwards)
            for (const day of allDays) {
              if (day.contributionCount > 0) {
                currentStreak++;
              } else {
                break;
              }
            }

            // Calculate longest streak
            for (const day of weeks.flatMap(w => w.contributionDays)) {
              if (day.contributionCount > 0) {
                tempStreak++;
                longestStreak = Math.max(longestStreak, tempStreak);
              } else {
                tempStreak = 0;
              }
            }

            return { currentStreak, longestStreak };
          }

          function generateSVG(currentStreak, longestStreak, totalContributions) {
            return `<svg xmlns="http://www.w3.org/2000/svg" width="847" height="140" viewBox="0 0 847 140">
            <rect width="847" height="140" rx="6" fill="#21262d"/>
            
            <!-- Title - Blue, no bold, no emoji -->
            <text x="423.5" y="25" text-anchor="middle" fill="#58a6ff" font-family="Segoe UI, Ubuntu, Arial, sans-serif" font-size="14">GitHub Streak Stats</text>
            
            <!-- Current Streak - All green -->
            <text x="141" y="55" text-anchor="middle" fill="#38bdae" font-family="Segoe UI, Ubuntu, Arial, sans-serif" font-size="12">Current Streak</text>
            <text x="141" y="95" text-anchor="middle" fill="#38bdae" font-family="Segoe UI, Ubuntu, Arial, sans-serif" font-size="32" font-weight="700">${currentStreak}</text>
            <text x="141" y="115" text-anchor="middle" fill="#38bdae" font-family="Segoe UI, Ubuntu, Arial, sans-serif" font-size="11">days</text>
            
            <!-- Total Contributions - All green -->
            <text x="423.5" y="55" text-anchor="middle" fill="#38bdae" font-family="Segoe UI, Ubuntu, Arial, sans-serif" font-size="12">Total Contributions</text>
            <text x="423.5" y="95" text-anchor="middle" fill="#38bdae" font-family="Segoe UI, Ubuntu, Arial, sans-serif" font-size="32" font-weight="700">${totalContributions}</text>
            <text x="423.5" y="115" text-anchor="middle" fill="#38bdae" font-family="Segoe UI, Ubuntu, Arial, sans-serif" font-size="11">this year</text>
            
            <!-- Longest Streak - All green -->
            <text x="706" y="55" text-anchor="middle" fill="#38bdae" font-family="Segoe UI, Ubuntu, Arial, sans-serif" font-size="12">Longest Streak</text>
            <text x="706" y="95" text-anchor="middle" fill="#38bdae" font-family="Segoe UI, Ubuntu, Arial, sans-serif" font-size="32" font-weight="700">${longestStreak}</text>
            <text x="706" y="115" text-anchor="middle" fill="#38bdae" font-family="Segoe UI, Ubuntu, Arial, sans-serif" font-size="11">days</text>
          </svg>`;
          }

          async function main() {
            try {
              const data = await fetchContributions();
              const calendar = data.data.user.contributionsCollection.contributionCalendar;
              const { currentStreak, longestStreak } = calculateStreak(calendar.weeks);
              const svg = generateSVG(currentStreak, longestStreak, calendar.totalContributions);
              
              fs.mkdirSync('dist', { recursive: true });
              fs.writeFileSync('dist/streak.svg', svg);
              console.log('Generated streak:', currentStreak, longestStreak, calendar.totalContributions);
            } catch (err) {
              console.error('Error:', err);
              process.exit(1);
            }
          }

          main();
          EOF
          node generate-streak.js

      - name: Push to output branch
        uses: crazy-max/ghaction-github-pages@v3
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
